<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <title>Zadanie 4</title>
    <!-- <link rel="stylesheet" media="screen" href="css/style.css" /> -->
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body>
    <canvas id="myCanvas" width="1000" height="500" style="width: 1000px;height: 500px;">

    </canvas>
    <script>
        var interval;
        var c = document.getElementById("myCanvas");
        var ctx = c.getContext("2d");
        var strokeStyle = "black";

        const min = Math.min;
        const sin = Math.sin;
        const cos = Math.cos;
        const PI = Math.PI;

        function nextInt(s, e) {
            return Math.floor((Math.random() * (e-s+1))) + s;
        }

        function toRads(dd) {
            return dd / 180.0 * Math.PI;
        }

        function transform(arr3d) {
            res = [];
            for (i = 0; i < arr3d.length; i++) {
                temp = [arr3d[i][0] / arr3d[i][2], arr3d[i][1] / arr3d[i][2]]
                res.push(temp);
            }

            return res;
        }

        function transformWithDelta(arr3d) {
            res = [];
            for (i = 0; i < arr3d.length; i++) {
                zzz = arr3d[i][2]-deltaZ;
                temp = [arr3d[i][0] / zzz, arr3d[i][1] / zzz]
                res.push(temp);
            }

            return res;
        }

        function transformMap(arr3d) {
            res = [];
            for (i = 0; i < arr3d.length; i++) {
                zzz = arr3d[i][2];
                if (zzz == 10) {
                    zzz -= deltaZ;
                }
                temp = [arr3d[i][0] / zzz, arr3d[i][1] / zzz]
                res.push(temp);
            }

            return res;
        }


        function moveTo(x, y) {
            ctx.moveTo(x + 500, y + 250);
        }

        function lineTo(x, y) {
            ctx.lineTo(x + 500, y + 250);
        }

        function drawFigure(vertexes, edges, edgeColor) {
            ctx.beginPath();
            var v;
            var e;
            ctx.strokeStyle = edgeColor;

            vertexes = transform(vertexes);

            for (i = 0; i < edges.length; i++) {
                e = edges[i];
                p = vertexes[e[0]];
                moveTo(p[0], p[1]);
                p = vertexes[e[1]];
                lineTo(p[0], p[1]);
            }

            ctx.stroke();
        }



        function drawMap(vertexes, edges, edgeColor) {
            ctx.beginPath();
            var v;
            var e;
            ctx.strokeStyle = edgeColor;

            vertexes = transformMap(vertexes);

            for (i = 0; i < edges.length; i++) {
                e = edges[i];
                p = vertexes[e[0]];
                moveTo(p[0], p[1]);
                p = vertexes[e[1]];
                lineTo(p[0], p[1]);
            }

            ctx.stroke();
        }

        function drawFigureWithDelta(vertexes, edges, edgeColor) {
            ctx.beginPath();
            var v;
            var e;
            ctx.strokeStyle = edgeColor;

            vertexes = transformWithDelta(vertexes);

            for (i = 0; i < edges.length; i++) {
                e = edges[i];
                p = vertexes[e[0]];
                moveTo(p[0], p[1]);
                p = vertexes[e[1]];
                lineTo(p[0], p[1]);
            }

            ctx.stroke();
        }
        

        var mapVertexes3D = [
            [500, 250, 1], // 0 
            [-500, 250, 1], // 1
            [-500, -250, 1], // 2
            [500, -250, 1], // 3
            [500, 250, 10], // 4
            [-500, 250, 10], // 5
            [-500, -250, 10], // 6
            [500, -250, 10], // 7
        ]

        var edges = [
            [0, 1],
            [0, 3],
            [0, 4],
            [1, 2],
            [1, 5],
            [2, 3],
            [2, 6],
            [3, 7],
            [4, 5],
            [4, 7],
            [5, 6],
            [6, 7]
        ];
        


        var door;
        var obstacleVertexes = [];
        var doors = [];
        function obstacleReset() {
            obstacleVertexes = [];
            doors = [];
            for (j = 2; j < 9; j+=2) {
                door = nextInt(-5,3)/2;
                // door = -2.5;
                doors.push(door);
                if (door > -2.5) {
                    temp = [
                        [door * 200, 250, j], // 0 
                        [-500, 250, j], // 1
                        [-500, -250, j], // 2
                        [door * 200, -250, j], // 3
                        [door * 200, 250, j+1], // 4
                        [-500, 250, j+1], // 5
                        [-500, -250, j+1], // 6
                        [door * 200, -250, j+1], // 7
                    ];
                    obstacleVertexes.push(temp);
                    // drawFigure(obstacleVertexes, edges, "black");
                }

                if (door < 2) {
                    temp = [
                        [door * 200 + 200, 250, j], // 0 
                        [500, 250, j], // 1
                        [500, -250, j], // 2
                        [door * 200 + 200, -250, j], // 3
                        [door * 200 + 200, 250, j + 1], // 4
                        [500, 250, j + 1], // 5
                        [500, -250, j + 1], // 6
                        [door * 200 + 200, -250, j + 1], // 7
                    ];
                    obstacleVertexes.push(temp);
                    // drawFigure(obstacleVertexes, edges, "black");
                }
            }
        }

        obstacleReset();
        
        var deltaZ = 0;
        var character = {};

        function characterReset() {
            deltaZ = 0;
            character.x = 0;
            character.y = 0;
            character.z = 1;
            character.vertexes = [
                [50, 250, 1.25], // 0 
                [-50, 250, 1.25], // 1
                [-50, 50, 1.25], // 2
                [50, 50, 1.25], // 3
                [50, 250, 1.75], // 4
                [-50, 250, 1.75], // 5
                [-50, 50, 1.75], // 6
                [50, 50, 1.75], // 7  
            ];
        }

        characterReset();

        function draw() {
            ctx.clearRect(0,0,1000,500);
            drawMap(mapVertexes3D, edges, "black");
            for (j = obstacleVertexes.length-1; j >= 0 ; j--) {
                if (obstacleVertexes[j][0][2] >= character.z) {
                    drawFigureWithDelta(obstacleVertexes[j], edges, "black");
                }
            }
            drawFigure(character.vertexes, edges, "blue");
            drawFigure(character.vertexes, edges, "blue");
            drawFigure(character.vertexes, edges, "blue");
        }

        function characterMoveRight() {
            if (character.x < 4 && character.z % 2 == 1) {
                character.x = character.x + 1;
                for (j = 0; j < character.vertexes.length; j++) {
                    character.vertexes[j][0] += 100;
                }
            }
        }

        function characterMoveLeft() {
            if (character.x > -4 && character.z % 2 == 1) {
                character.x = character.x - 1;
                for (j = 0; j < character.vertexes.length; j++) {
                    character.vertexes[j][0] -= 100;
                }
            }
        }

        var win = 0;

        function stageForward() {
            if (character.z < 9) {
                if ((character.x - 1)/2 == doors[0]) {
                    character.z += 2;
                    deltaZ += 2;
                    draw();
                    if (character.z == 9) {
                        stopGame();
                        setTimeout(function () {
                            alert("Wygrałeś");
                            obstacleReset();
                            characterReset();
                            startGame();
                        }, 100);
                    }
                    doors.shift();
                } else {
                    stopGame();
                    draw();
                    setTimeout(function() {
                        alert("Przegrałeś");
                        obstacleReset();
                        characterReset();
                        startGame();
                    }, 100);
                }
            }
        }
        
        document.addEventListener("keypress", function(e) {
            e.preventDefault();
            var code = e.which || e.keyCode;
            switch(code) {
                case 100:
                    characterMoveRight();
                    break;
                case 97:
                    characterMoveLeft();
                    break;
                // case 119:
                //     characterForward();
                //     break;
            }
            
            draw();
        });

        var stopped = false;
        function startGame() {
            draw();
            stopped = false;
            interval = setInterval(function() {
                if (!stopped) {
                    stageForward();
                }
            }, 2000);
        }

        function stopGame() {
            stopped = true;
            clearInterval(interval);
        }

        startGame();

    </script>
</body>

</html>